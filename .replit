modules = ["bun-1.2", "postgresql-16"]

run = "spin up"

# The main configuration file for your project.
entrypoint = "spin.toml"

# Hides clutter from the file tree.
hidden = [".config", "bun.lockb", "target", "node_modules", ".cache"]

# This section configures the Nix environment.
# NOTICE: The 'channel' line has been REMOVED.
# This tells Replit to use its own default, stable channel, which avoids the error.
[nix]

# Provides language server support for Rust.
[languages.rust]
pattern = "**/*.rs"
[languages.rust.languageServer]
start = "rust-analyzer"

# Provides language server support for TOML files.
[languages.toml]
pattern = "**/*.toml"
[languages.toml.languageServer]
start = "taplo lsp"

[workflows]

[[workflows.workflow]]
name = "Run"
author = 41744552
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "cd frontend && bun run build"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "cd gateway && cargo build --target wasm32-wasi --release"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "cd backend && cargo build --target wasm32-wasi --release --workspace --exclude shared"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "spin build"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "spin up --listen 0.0.0.0:3000"

[[workflows.workflow]]
name = "build:all"
author = 41744552
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "cd frontend && bun run build"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "cd gateway && cargo build --target wasm32-wasi --release"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "cd backend && cargo build --target wasm32-wasi --release --workspace --exclude shared"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "sqlx migrate run --database-url $DATABASE_URL"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "spin build"

[[workflows.workflow]]
name = "deploy:local"
author = 41744552
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "cd frontend && bun run build"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "cd gateway && cargo build --target wasm32-wasi --release"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "cd backend && cargo build --target wasm32-wasi --release --workspace --exclude shared"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "sqlx migrate run --database-url $DATABASE_URL"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "spin build"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "spin up --listen 0.0.0.0:3000"

[[workflows.workflow]]
name = "deploy:prod"
author = 41744552
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "cd frontend && bun run build"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "cd gateway && cargo build --target wasm32-wasi --release"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "cd backend && cargo build --target wasm32-wasi --release --workspace --exclude shared"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "sqlx migrate run --database-url $DATABASE_URL"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "spin build"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "spin login"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "spin deploy"
