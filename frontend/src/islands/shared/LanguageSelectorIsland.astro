---
import { i18nStore, type Locale } from '@/stores/i18nStore';

interface LanguageSelectorIslandProps {
  class?: string;
  showFlags?: boolean;
  compact?: boolean;
}

interface Language {
  code: Locale;
  name: string;
  flag: string;
}

// Fetch the 15 most-spoken Camino languages + all co-official Spanish languages
// via the gateway island.  Alpine will dispatch the request and handle the
// asynchronous response so we can keep the island fully SSR-compatible.
const languages: Language[] = await (async () => {
  try {
    // Fire-and-forget non-blocking call to our gateway
    const res = await fetch('/api/gateway/camino-languages', {
      method: 'GET',
      headers: { 
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      keepalive: true
    });

    if (!res.ok) throw new Error(`Gateway error: ${res.status}`);

    // Gateway returns: [{code, name, flag}, ...]
    const data = await res.json();
    return data;
  } catch (error) {
    console.warn('Failed to fetch languages from gateway:', error);
    // Fallback: minimal safe set if gateway or API is unreachable
    return [
      { code: 'es', name: 'EspaÃ±ol', flag: 'ðŸ‡ªðŸ‡¸' },
      { code: 'en', name: 'English', flag: 'ðŸ‡¬ðŸ‡§' },
      { code: 'fr', name: 'FranÃ§ais', flag: 'ðŸ‡«ðŸ‡·' },
      { code: 'de', name: 'Deutsch', flag: 'ðŸ‡©ðŸ‡ª' },
      { code: 'it', name: 'Italiano', flag: 'ðŸ‡®ðŸ‡¹' },
      { code: 'pt', name: 'PortuguÃªs', flag: 'ðŸ‡µðŸ‡¹' },
      { code: 'nl', name: 'Nederlands', flag: 'ðŸ‡³ðŸ‡±' },
      { code: 'pl', name: 'Polski', flag: 'ðŸ‡µðŸ‡±' },
      { code: 'ko', name: 'í•œêµ­ì–´', flag: 'ðŸ‡°ðŸ‡·' },
      { code: 'ja', name: 'æ—¥æœ¬èªž', flag: 'ðŸ‡¯ðŸ‡µ' },
      { code: 'zh', name: 'ä¸­æ–‡', flag: 'ðŸ‡¨ðŸ‡³' },
      { code: 'ru', name: 'Ð ÑƒÑÑÐºÐ¸Ð¹', flag: 'ðŸ‡·ðŸ‡º' },
      { code: 'cs', name: 'ÄŒeÅ¡tina', flag: 'ðŸ‡¨ðŸ‡¿' },
      { code: 'sk', name: 'SlovenÄina', flag: 'ðŸ‡¸ðŸ‡°' },
      { code: 'hu', name: 'Magyar', flag: 'ðŸ‡­ðŸ‡º' },
      { code: 'ca', name: 'CatalÃ ', flag: 'ðŸ´' },
      { code: 'eu', name: 'Euskara', flag: 'ðŸ´' },
      { code: 'gl', name: 'Galego', flag: 'ðŸ´' },
      { code: 'oc', name: 'Occitan (AranÃ©s)', flag: 'ðŸ´' },
      { code: 'Gode', name: 'Gothic', flag: 'ðŸ´' }
    ];
  }
})( );

// Get current locale from store
const currentLocale = i18nStore.get().locale;
const currentLanguage = languages.find(lang => lang.code === currentLocale) || languages[0];

// Generate unique ID for Alpine.js component
const componentId = `language-selector-${Math.random().toString(36).substr(2, 9)}`;

const { class: className = '', showFlags = true, compact = false } = Astro.props;
---

<div 
  id={componentId}
  class={`language-selector relative ${className}`}
  x-data={`{
    isOpen: false,
    currentLanguage: ${JSON.stringify(currentLanguage)},
    languages: ${JSON.stringify(languages)},
    selectedLanguage: ${JSON.stringify(currentLanguage.code)},
    
    toggleDropdown() {
      this.isOpen = !this.isOpen;
      if (this.isOpen) {
        this.$nextTick(() => {
          this.$refs.dropdown.focus();
        });
      }
    },
    
    async selectLanguage(code) {
      this.selectedLanguage = code;
      this.isOpen = false;
      
      try {
        // Use async, non-blocking request to gateway API
        const response = await fetch('/api/auth/change-language', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify({ 
            locale: code,
            timestamp: new Date().toISOString()
          }),
          // Use keepalive for non-blocking requests
          keepalive: true
        });

        const data = await response.json();
        
        if (response.ok && data.success) {
          // Update HTML lang attribute
          document.documentElement.lang = code;
          // Update current language display
          this.currentLanguage = this.languages.find(lang => lang.code === code);
          
          // Use client-side navigation instead of full reload for better UX
          if (window.location.pathname !== window.location.pathname) {
            window.location.reload();
          }
        } else {
          throw new Error(data.error || 'Failed to change language');
        }
      } catch (error) {
        console.error('Language change failed:', error);
        // Could show a user-friendly error message here
        // For now, revert the selection
        this.selectedLanguage = this.currentLanguage.code;
      }
    },
    
    closeDropdown() {
      this.isOpen = false;
    },
    
    handleKeydown(event) {
      if (event.key === 'Escape') {
        this.closeDropdown();
      } else if (event.key === 'Enter' || event.key === ' ') {
        if (!this.isOpen) {
          this.toggleDropdown();
        }
      }
    }
  }`}
  x-init="$watch('isOpen', value => {
    if (value) {
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.language-selector')) {
          this.isOpen = false;
        }
      });
    }
  })"
>
  {/* Trigger Button */}
  <button
    type="button"
    @click="toggleDropdown"
    @keydown="handleKeydown"
    class="flex items-center gap-2 px-4 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 transition-all duration-200"
    :class="{'text-sm': ${compact}}"
    aria-label="Seleccionar idioma"
    aria-expanded="false"
    aria-haspopup="true"
    aria-controls={`${componentId}-dropdown`}
    x-ref="trigger"
  >
    {/* Flag Display */}
    {showFlags && (
      <span class="text-lg" aria-hidden="true" x-text="currentLanguage.flag"></span>
    )}
    
    {/* Language Name/Code */}
    <span class="font-medium text-gray-700" x-text="${compact ? 'currentLanguage.code.toUpperCase()' : 'currentLanguage.name'}"></span>
    
    {/* Custom SVG Arrow with RoughJS styling */}
    <svg
      class="w-4 h-4 text-gray-500 transition-transform duration-200"
      viewBox="0 0 24 24"
      aria-hidden="true"
      x-bind:class="{ 'rotate-180': isOpen }"
    >
      <path
        d="M19 9l-7 7-7-7"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        fill="none"
      />
    </svg>
  </button>

  {/* Dropdown Menu */}
  <div 
    id={`${componentId}-dropdown`}
    class="absolute top-full left-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-50"
    role="menu"
    aria-labelledby={`${componentId}-trigger`}
    x-show="isOpen"
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0 transform scale-95"
    x-transition:enter-end="opacity-100 transform scale-100"
    x-transition:leave="transition ease-in duration-150"
    x-transition:leave-start="opacity-100 transform scale-100"
    x-transition:leave-end="opacity-0 transform scale-95"
    x-ref="dropdown"
    tabindex="-1"
  >
    <div class="py-1">
      {languages.map((language) => (
        <button
          type="button"
          @click={`selectLanguage('${language.code}')`}
          class="w-full flex items-center gap-3 px-4 py-2 text-left hover:bg-gray-50 focus:bg-gray-50 focus:outline-none transition-colors duration-150"
          :class={`selectedLanguage === '${language.code}' ? 'bg-primary-50 text-primary-700' : 'text-gray-700'`}
          aria-label={`Cambiar a ${language.name}`}
          role="menuitem"
          :aria-selected={`selectedLanguage === '${language.code}'`}
          x-bind:aria-selected={`selectedLanguage === '${language.code}'`}
        >
          {/* Language Flag */}
          {showFlags && (
            <span class="text-lg" aria-hidden="true" x-text={JSON.stringify(language.flag)}></span>
          )}
          
          {/* Language Info */}
          <div class="flex-1">
            <div class="font-medium" x-text={JSON.stringify(language.name)}></div>
            <div class="text-sm text-gray-500" x-text={JSON.stringify(language.code.toUpperCase())}></div>
          </div>
          
          {/* Checkmark for selected language */}
          {currentLanguage.code === language.code && (
            <svg
              class="w-4 h-4 text-primary-600"
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path
                d="M5 13l4 4L19 7"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                fill="none"
              />
            </svg>
          )}
        </button>
      ))}
    </div>
  </div>
</div>
