# Spin/Fermyon Cloud deployment tasks
# WASM-based deployment for cloud-native architecture

version: "3"

vars:
  SPIN_APP_NAME: '{{.SPIN_APP_NAME | default "albergue-carrascalejo"}}'
  SPIN_REGISTRY: '{{.SPIN_REGISTRY | default "ghcr.io"}}'
  SPIN_TAG: '{{.SPIN_TAG | default "latest"}}'
  FERMYON_CLOUD_URL: '{{.FERMYON_CLOUD_URL | default "https://cloud.fermyon.com"}}'
  SPIN_MANIFEST: '{{.SPIN_MANIFEST | default "spin.toml"}}'

env:
  SPIN_APP_NAME: "{{.SPIN_APP_NAME}}"
  SPIN_REGISTRY: "{{.SPIN_REGISTRY}}"
  SPIN_TAG: "{{.SPIN_TAG}}"
  FERMYON_CLOUD_URL: "{{.FERMYON_CLOUD_URL}}"

tasks:
  # Spin development
  spin:dev:
    desc: Start Spin development environment
    cmds:
      - echo "ğŸš€ Starting Spin development environment..."
      - task: spin:build
      - task: spin:up

  spin:build:
    desc: Build Spin WASM components
    cmds:
      - echo "ğŸ—ï¸ Building Spin WASM components..."
      - spin build
      - echo "âœ… Spin components built successfully"

  spin:up:
    desc: Start Spin local development server
    cmds:
      - echo "ğŸŒ Starting Spin local server..."
      - spin up --listen 127.0.0.1:3000
      - echo "âœ… Spin server running at http://localhost:3000"

  spin:watch:
    desc: Watch and rebuild Spin components
    cmds:
      - echo "ğŸ‘€ Watching for changes..."
      - spin watch

  spin:test:
    desc: Test Spin components
    cmds:
      - echo "ğŸ§ª Testing Spin components..."
      - spin test
      - echo "âœ… Spin tests completed"

  spin:validate:
    desc: Validate Spin manifest and components
    cmds:
      - echo "ğŸ” Validating Spin configuration..."
      - spin doctor
      - echo "âœ… Spin validation completed"

  # Spin production build
  spin:build:prod:
    desc: Build Spin for production
    cmds:
      - echo "ğŸ­ Building Spin for production..."
      - NODE_ENV=production spin build --release
      - echo "âœ… Production build completed"

  spin:optimize:
    desc: Optimize WASM components
    cmds:
      - echo "âš¡ Optimizing WASM components..."
      - find target/wasm32-wasi/release -name "*.wasm" -exec wasm-opt -Oz -o {} {} \;
      - echo "âœ… WASM optimization completed"

  # Spin deployment
  spin:deploy:
    desc: Deploy to Fermyon Cloud
    deps: [spin:build:prod, spin:validate]
    cmds:
      - echo "â˜ï¸ Deploying to Fermyon Cloud..."
      - spin deploy
      - echo "âœ… Deployment to Fermyon Cloud completed"

  spin:deploy:staging:
    desc: Deploy to staging environment
    cmds:
      - echo "ğŸ§ª Deploying to staging..."
      - SPIN_ENV=staging spin deploy
      - echo "âœ… Staging deployment completed"

  spin:deploy:local:
    desc: Deploy locally with Spin
    cmds:
      - echo "ğŸ  Deploying locally..."
      - task: spin:build
      - task: spin:up

  # Spin registry management
  spin:push:
    desc: Push Spin app to registry
    cmds:
      - echo "ğŸ“¤ Pushing to registry..."
      - spin registry push {{.SPIN_REGISTRY}}/{{.SPIN_APP_NAME}}:{{.SPIN_TAG}}
      - echo "âœ… Registry push completed"

  spin:pull:
    desc: Pull Spin app from registry
    cmds:
      - echo "ğŸ“¥ Pulling from registry..."
      - spin registry pull {{.SPIN_REGISTRY}}/{{.SPIN_APP_NAME}}:{{.SPIN_TAG}}
      - echo "âœ… Registry pull completed"

  # Spin component management
  spin:add:
    desc: Add new Spin component
    cmds:
      - echo "â• Adding new Spin component..."
      - echo "Usage: task spin:add COMPONENT_NAME TEMPLATE"
      - echo "Available templates: http-rust, http-go, http-ts, redis-rust, redis-go"

  spin:remove:
    desc: Remove Spin component
    cmds:
      - echo "â– Removing Spin component..."
      - echo "Usage: task spin:remove COMPONENT_NAME"

  # Spin secrets management
  spin:secrets:list:
    desc: List Spin secrets
    cmds:
      - echo "ğŸ” Listing Spin secrets..."
      - spin secrets list

  spin:secrets:set:
    desc: Set Spin secret
    cmds:
      - echo "ğŸ”‘ Setting Spin secret..."
      - echo "Usage: task spin:secrets:set KEY VALUE"

  spin:secrets:delete:
    desc: Delete Spin secret
    cmds:
      - echo "ğŸ—‘ï¸ Deleting Spin secret..."
      - echo "Usage: task spin:secrets:delete KEY"

  # Spin key-value management
  spin:kv:list:
    desc: List Spin key-value stores
    cmds:
      - echo "ğŸ—ƒï¸ Listing Spin key-value stores..."
      - spin kv list

  spin:kv:create:
    desc: Create Spin key-value store
    cmds:
      - echo "ğŸ—ï¸ Creating Spin key-value store..."
      - echo "Usage: task spin:kv:create STORE_NAME"

  spin:kv:delete:
    desc: Delete Spin key-value store
    cmds:
      - echo "ğŸ—‘ï¸ Deleting Spin key-value store..."
      - echo "Usage: task spin:kv:delete STORE_NAME"

  # Spin logs
  spin:logs:
    desc: View Spin application logs
    cmds:
      - echo "ğŸ“ Viewing Spin logs..."
      - spin logs

  spin:logs:follow:
    desc: Follow Spin application logs
    cmds:
      - echo "ğŸ‘€ Following Spin logs..."
      - spin logs --follow

  # Spin health checks
  spin:health:
    desc: Check Spin application health
    cmds:
      - echo "ğŸ¥ Checking Spin application health..."
      - curl -f http://localhost:3000/health || echo "âš ï¸ Health check failed"

  spin:status:
    desc: Check Spin application status
    cmds:
      - echo "ğŸ“Š Checking Spin application status..."
      - spin status

  # Spin cleanup
  spin:clean:
    desc: Clean Spin build artifacts
    cmds:
      - echo "ğŸ§¹ Cleaning Spin build artifacts..."
      - rm -rf target/
      - rm -rf .spin/
      - echo "âœ… Spin artifacts cleaned"

  # Spin upgrade
  spin:upgrade:
    desc: Upgrade Spin CLI
    cmds:
      - echo "â¬†ï¸ Upgrading Spin CLI..."
      - spin upgrade
      - echo "âœ… Spin CLI upgraded"

  # Spin plugin management
  spin:plugins:list:
    desc: List Spin plugins
    cmds:
      - echo "ğŸ”Œ Listing Spin plugins..."
      - spin plugins list

  spin:plugins:install:
    desc: Install Spin plugin
    cmds:
      - echo "ğŸ“¦ Installing Spin plugin..."
      - echo "Usage: task spin:plugins:install PLUGIN_NAME"

  spin:plugins:uninstall:
    desc: Uninstall Spin plugin
    cmds:
      - echo "ğŸ—‘ï¸ Uninstalling Spin plugin..."
      - echo "Usage: task spin:plugins:uninstall PLUGIN_NAME"

  # Default task
  default:
    desc: Show Spin tasks
    cmds:
      - echo "ğŸ¯ Spin/Fermyon Cloud Tasks"
      - echo ""
      - echo "Development:"
      - echo "  task spin:dev          - Start development environment"
      - echo "  task spin:build        - Build WASM components"
      - echo "  task spin:test         - Test components"
      - echo ""
      - echo "Production:"
      - echo "  task spin:build:prod   - Build for production"
      - echo "  task spin:deploy       - Deploy to Fermyon Cloud"
      - echo ""
      - echo "Management:"
      - echo "  task spin:secrets:list - List secrets"
      - echo "  task spin:kv:list      - List key-value stores"
      - echo "  task spin:logs         - View logs"
      - echo "  task spin:clean        - Clean artifacts"
