name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  NODE_ENV: test
  PUBLIC_API_MODE: local

jobs:
  # Frontend CI
  frontend:
    name: Frontend Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Type check
        run: pnpm type-check

      - name: Lint
        run: pnpm lint

      - name: Unit tests
        run: pnpm test:unit

      - name: Build
        run: pnpm build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist/

  # Gateway CI
  gateway:
    name: Gateway Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: gateway

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v3
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v3
        with:
          path: gateway/target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('gateway/Cargo.lock') }}

      - name: Format check
        run: cargo fmt --all -- --check

      - name: Clippy
        run: cargo clippy --all-targets --all-features

      - name: Test
        run: cargo test --all

      - name: Build
        run: cargo build --release

  # Database CI
  database:
    name: Database Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: albergue_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Wait for PostgreSQL
        run: |
          timeout 30 bash -c 'until pg_isready -h localhost -p 5432; do sleep 1; done'

      - name: Apply migrations
        run: |
          for migration in domain_model/migrations/*.sql; do
            echo "Applying $migration"
            psql -h localhost -U postgres -d albergue_test -f "$migration"
          done
        env:
          PGPASSWORD: postgres

      - name: Apply test seed
        run: |
          psql -h localhost -U postgres -d albergue_test -f domain_model/seed/test_seed.sql
        env:
          PGPASSWORD: postgres

      - name: Run SQL tests
        run: |
          for test in domain_model/test/*.sql; do
            echo "Running $test"
            psql -h localhost -U postgres -d albergue_test -f "$test"
          done
        env:
          PGPASSWORD: postgres

  # Integration Tests
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [frontend, gateway, database]
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: albergue_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: |
          cd frontend && pnpm install --frozen-lockfile
          cd ../gateway && cargo build --release

      - name: Setup database
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
          for migration in domain_model/migrations/*.sql; do
            PGPASSWORD=postgres psql -h localhost -U postgres -d albergue_test -f "$migration"
          done
          PGPASSWORD=postgres psql -h localhost -U postgres -d albergue_test -f domain_model/seed/test_seed.sql

      - name: Run frontend integration tests
        run: |
          cd frontend
          pnpm test:integration

      - name: Run gateway integration tests
        run: |
          cd gateway
          cargo test --release

  # E2E Tests
  e2e:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: [frontend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: |
          cd frontend
          pnpm install --frozen-lockfile

      - name: Install Playwright
        run: |
          cd frontend
          pnpm exec playwright install --with-deps

      - name: Build frontend
        run: |
          cd frontend
          pnpm build

      - name: Run E2E tests
        run: |
          cd frontend
          pnpm test:e2e

      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: frontend/test-results/

  # Security Scan
  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: |
          cd frontend
          pnpm install --frozen-lockfile

      - name: Run security audit
        run: |
          cd frontend
          pnpm audit --audit-level=high

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run cargo audit
        run: |
          cd gateway
          cargo audit

  # Performance Test
  performance:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: [frontend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: |
          cd frontend
          pnpm install --frozen-lockfile

      - name: Build frontend
        run: |
          cd frontend
          pnpm build

      - name: Run Lighthouse CI
        run: |
          cd frontend
          pnpm dlx @lhci/cli@latest autorun

  # Deployment Check
  deploy-check:
    name: Deployment Readiness
    runs-on: ubuntu-latest
    needs: [frontend, gateway, database, integration, e2e, security]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: |
          cd frontend
          pnpm install --frozen-lockfile

      - name: Build for production
        run: |
          cd frontend
          pnpm build

      - name: Check build artifacts
        run: |
          cd frontend
          ls -la dist/
          test -f dist/index.html
          echo "âœ… Build artifacts ready for deployment"



