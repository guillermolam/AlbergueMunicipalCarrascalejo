~/workspace$ task
task: [test:unit:rust] echo "ğŸ§ª Ejecutando tests unitarios de Rust..."
task: [test:unit:frontend] echo "ğŸ§ª Ejecutando tests unitarios del frontend principal..."
task: [test:unit:auth-frontend] echo "ğŸ§ª Ejecutando tests unitarios del frontend de auth..."
task: [test:integration:api] echo "ğŸ”— Ejecutando tests de integraciÃ³n de API..."
task: [performance:k6] echo "âš¡ Ejecutando tests de carga con k6..."
task: [lint:trunk] echo "ğŸ” Ejecutando Trunk.io en todo el proyecto..."
task: [setup:check] echo "ğŸ” Verificando entorno de desarrollo..."
task: [sast:cargo-audit] echo "ğŸ”’ Ejecutando auditorÃ­a de seguridad de Cargo..."
task: [test:integration:database] echo "ğŸ—„ï¸  Ejecutando tests de integraciÃ³n de base de datos..."
task: [security:dast:nuclei] echo "ğŸ”’ Ejecutando escaneo de vulnerabilidades con Nuclei..."
task: [security:dast:zap] echo "ğŸ”’ Ejecutando escaneo de seguridad con OWASP ZAP..."
task: [lint:rust] echo "ğŸ” Ejecutando clippy en todo el workspace..."
task: [performance:lighthouse] echo "âš¡ Ejecutando auditorÃ­a de rendimiento con Lighthouse..."
task: [setup:deps:rust] echo "ğŸ¦€ Instalando dependencias de Rust..."
task: [build:backend] echo "ğŸ—ï¸  Construyendo todos los microservicios backend..."
task: [test:e2e:testcafe] echo "ğŸ­ Ejecutando tests E2E con TestCafe..."
task: [build:frontend] echo "ğŸ—ï¸  Construyendo frontend principal..."
task: [sast:trunk-security] echo "ğŸ”’ Ejecutando checks de seguridad con Trunk.io..."
task: [lint:auth-frontend] echo "ğŸ” Ejecutando lint en frontend de auth..."
task: [setup:deps:frontend] echo "ğŸ“¦ Instalando dependencias del frontend principal..."
task: [format:check:auth-frontend] if command -v prettier >/dev/null 2>&1; then
  npx prettier --check "src/**/*.{ts,tsx,js,jsx,json,css,md}" || echo "âš ï¸  Auth frontend formatting check failed"
else
  echo "âš ï¸  Prettier not available, skipping auth frontend format check"
fi

task: [test:e2e:comprehensive] echo "ğŸ­ Ejecutando suite completa de tests E2E..."
task: [build:auth-frontend] echo "ğŸ—ï¸  Construyendo frontend de auth service..."
task: [lint:frontend] echo "ğŸ” Ejecutando lint en frontend principal..."
task: [setup:deps:auth-frontend] echo "ğŸ“¦ Instalando dependencias del frontend de auth..."
task: [build:gateway] echo "ğŸ—ï¸  Construyendo Gateway BFF..."
task: [compatibility:browsers] echo "ğŸŒ Ejecutando tests de compatibilidad de navegadores..."
task: [format:check:frontend] if command -v prettier >/dev/null 2>&1; then
  npx prettier --check "src/**/*.{ts,tsx,js,jsx,json,css,md}" || echo "âš ï¸  Frontend formatting check failed"
else
  echo "âš ï¸  Prettier not available, skipping frontend format check"
fi

task: [compatibility:devices] echo "ğŸ“± Ejecutando tests de compatibilidad de dispositivos..."
task: [format:check:rust] cargo fmt --all -- --check
task: [sast:semgrep] echo "ğŸ”’ Ejecutando anÃ¡lisis de seguridad con Semgrep..."
ğŸ§ª Ejecutando tests unitarios de Rust...
task: [test:unit:rust] cargo test --workspace --lib
ğŸ”’ Ejecutando escaneo de seguridad con OWASP ZAP...
task: [security:dast:zap] if command -v zap-baseline.py >/dev/null 2>&1; then
  if [ -f "tests/infrastructure/security/zap-rules.tsv" ]; then
    zap-baseline.py -t http://0.0.0.0:49985 -c tests/infrastructure/security/zap-rules.tsv
  else
    zap-baseline.py -t http://0.0.0.0:49985
  fi
else
  echo "âš ï¸  OWASP ZAP not installed, skipping DAST scan"
fi

âš¡ Ejecutando tests de carga con k6...
task: [performance:k6] if command -v k6 >/dev/null 2>&1; then
  if [ -f "tests/infrastructure/performance/api-load-test.js" ]; then
    k6 run tests/infrastructure/performance/api-load-test.js
  else
    echo "âš ï¸  k6 load test script not found"
  fi
else
  echo "âš ï¸  k6 not installed, skipping load tests"
fi

ğŸ—ï¸  Construyendo todos los microservicios backend...
task: [build:backend] cargo build --workspace --target wasm32-wasi --release --exclude shared
ğŸ”— Ejecutando tests de integraciÃ³n de API...
task: [test:integration:api] for test_file in *.js *.mjs; do
  if [ -f "$test_file" ]; then
    echo "  ğŸ§ª Ejecutando $test_file..."
    if [[ "$test_file" == *.mjs ]]; then
      node "$test_file" || echo "âš ï¸  Test $test_file failed"
    else
      node "$test_file" || echo "âš ï¸  Test $test_file failed"
    fi
  fi
done

ğŸ” Verificando entorno de desarrollo...
task: [setup:check] rustc --version
ğŸ—ï¸  Construyendo frontend principal...
task: [build:frontend] npm run build || pnpm run build || bun run build
ğŸ” Ejecutando clippy en todo el workspace...
task: [lint:rust] cargo clippy --workspace --all-targets --all-features -- -D warnings
ğŸ“± Ejecutando tests de compatibilidad de dispositivos...
ğŸ” Ejecutando Trunk.io en todo el proyecto...
task: [lint:trunk] if command -v trunk >/dev/null 2>&1; then
  trunk check --all
else
  echo "âš ï¸  Trunk.io not installed, skipping"
fi

task: [compatibility:devices] # Try different ways to find testcafe
TESTCAFE_CMD=""
if command -v testcafe >/dev/null 2>&1; then
  TESTCAFE_CMD="testcafe"
elif command -v npx >/dev/null 2>&1; then
  TESTCAFE_CMD="npx testcafe"
elif [ -f "frontend/node_modules/.bin/testcafe" ]; then
  TESTCAFE_CMD="frontend/node_modules/.bin/testcafe"
fi

if [ -n "$TESTCAFE_CMD" ]; then
  if [ -f "tests/e2e/testcafe/test-dni-simple.js" ]; then
    echo "  ğŸ“± Testing iPhone..."
    $TESTCAFE_CMD chrome:headless:emulation:device=iPhone tests/e2e/testcafe/test-dni-simple.js || echo "âš ï¸  iPhone test failed"
    echo "  ğŸ“± Testing iPad..."
    $TESTCAFE_CMD chrome:headless:emulation:device=iPad tests/e2e/testcafe/test-dni-simple.js || echo "âš ï¸  iPad test failed"
    echo "  ğŸ–¥ï¸  Testing Desktop..."
    $TESTCAFE_CMD chrome:headless:emulation:device=desktop tests/e2e/testcafe/test-dni-simple.js || echo "âš ï¸  Desktop test failed"
  else
    echo "âš ï¸  Device compatibility test file not found"
  fi
else
  echo "âš ï¸  TestCafe not available, skipping device compatibility tests"
fi

ğŸ—ï¸  Construyendo frontend de auth service...
ğŸ”’ Ejecutando auditorÃ­a de seguridad de Cargo...
task: [sast:cargo-audit] if ! command -v cargo-audit >/dev/null 2>&1; then
  cargo install cargo-audit
fi

ğŸ”’ Ejecutando escaneo de vulnerabilidades con Nuclei...
ğŸ“¦ Instalando dependencias del frontend principal...
task: [security:dast:nuclei] if command -v nuclei >/dev/null 2>&1; then
  nuclei -u http://0.0.0.0:49985 -severity medium,high,critical
else
  echo "âš ï¸  Nuclei not installed, skipping vulnerability scan"
fi

task: [setup:deps:frontend] npm install || pnpm install || bun install
ğŸ—ï¸  Construyendo Gateway BFF...
task: [build:gateway] cargo build --target wasm32-wasi --release
ğŸŒ Ejecutando tests de compatibilidad de navegadores...
task: [compatibility:browsers] # Try different ways to find testcafe
TESTCAFE_CMD=""
if command -v testcafe >/dev/null 2>&1; then
  TESTCAFE_CMD="testcafe"
elif command -v npx >/dev/null 2>&1; then
  TESTCAFE_CMD="npx testcafe"
elif [ -f "frontend/node_modules/.bin/testcafe" ]; then
  TESTCAFE_CMD="frontend/node_modules/.bin/testcafe"
fi

if [ -n "$TESTCAFE_CMD" ]; then
  if [ -f "tests/e2e/testcafe/test-dni-simple.js" ]; then
    echo "  ğŸ§ª Testing Chrome..."
    $TESTCAFE_CMD chrome:headless tests/e2e/testcafe/test-dni-simple.js || echo "âš ï¸  Chrome test failed"
    echo "  ğŸ§ª Testing Firefox..."
    $TESTCAFE_CMD firefox:headless tests/e2e/testcafe/test-dni-simple.js || echo "âš ï¸  Firefox test failed"
    echo "  ğŸ§ª Testing Safari..."
    $TESTCAFE_CMD safari tests/e2e/testcafe/test-dni-simple.js || echo "âš ï¸  Safari not available"
    echo "  ğŸ§ª Testing Edge..."
    $TESTCAFE_CMD edge tests/e2e/testcafe/test-dni-simple.js || echo "âš ï¸  Edge not available"
  else
    echo "âš ï¸  Browser compatibility test file not found"
  fi
else
  echo "âš ï¸  TestCafe not available, skipping browser compatibility tests"
fi

task: [build:auth-frontend] npm run build || pnpm run build || bun run build || echo "âš ï¸  Auth frontend build not configured"
ğŸ§ª Ejecutando tests unitarios del frontend principal...
task: [test:unit:frontend] bun run test
ğŸ§ª Ejecutando tests unitarios del frontend de auth...
task: [test:unit:auth-frontend] bun run test || echo "âš ï¸  Auth frontend tests not configured"
âš ï¸  Prettier not available, skipping auth frontend format check
ğŸ”’ Ejecutando checks de seguridad con Trunk.io...
task: [sast:trunk-security] if command -v trunk >/dev/null 2>&1; then
  trunk check --filter=security
else
  echo "âš ï¸  Trunk.io not available, skipping security checks"
fi

ğŸ” Ejecutando lint en frontend principal...
task: [lint:frontend] bun run lint
ğŸ” Ejecutando lint en frontend de auth...
task: [lint:auth-frontend] bun run lint || echo "âš ï¸  Auth frontend lint not configured"
âš ï¸  Prettier not available, skipping frontend format check
ğŸ­ Ejecutando suite completa de tests E2E...
task: [test:e2e:comprehensive] if [ -f "run-comprehensive-testcafe.js" ]; then
  node run-comprehensive-testcafe.js || echo "âš ï¸  Comprehensive E2E tests failed"
else
  echo "âš ï¸  Comprehensive test runner not found"
fi

ğŸ“¦ Instalando dependencias del frontend de auth...
task: [setup:deps:auth-frontend] npm install || pnpm install || bun install
ğŸ—„ï¸  Ejecutando tests de integraciÃ³n de base de datos...
task: [test:integration:database] if command -v psql >/dev/null 2>&1; then
  for sql_file in *.sql; do
    if [ -f "$sql_file" ]; then
      echo "  ğŸ§ª Ejecutando test de DB: $sql_file"
      psql "${DATABASE_URL}" -f "$sql_file" || echo "âš ï¸  Database test $sql_file failed"
    fi
  done
else
  echo "âš ï¸  PostgreSQL client not available, skipping database tests"
fi

ğŸ”’ Ejecutando anÃ¡lisis de seguridad con Semgrep...
task: [sast:semgrep] if command -v semgrep >/dev/null 2>&1; then
  semgrep --config=auto --error --strict --verbose .
else
  echo "âš ï¸  Semgrep not installed, skipping security analysis"
fi

âš¡ Ejecutando auditorÃ­a de rendimiento con Lighthouse...
task: [performance:lighthouse] # Try different ways to find lighthouse
LIGHTHOUSE_CMD=""
if command -v lighthouse >/dev/null 2>&1; then
  LIGHTHOUSE_CMD="lighthouse"
elif command -v npx >/dev/null 2>&1; then
  LIGHTHOUSE_CMD="npx lighthouse"
elif [ -f "frontend/node_modules/.bin/lighthouse" ]; then
  LIGHTHOUSE_CMD="frontend/node_modules/.bin/lighthouse"
fi

if [ -n "$LIGHTHOUSE_CMD" ]; then
  mkdir -p tests/infrastructure/performance
  echo "  ğŸƒ Running Lighthouse audit on http://0.0.0.0:49985"
  $LIGHTHOUSE_CMD http://0.0.0.0:49985 --output json --output-path ./tests/infrastructure/performance/lighthouse-results.json || echo "âš ï¸  Lighthouse audit failed"
  echo "  ğŸƒ Running Lighthouse audit on http://0.0.0.0:49985/admin"
  $LIGHTHOUSE_CMD http://0.0.0.0:49985/admin --output json --output-path ./tests/infrastructure/performance/lighthouse-admin-results.json || echo "âš ï¸  Lighthouse admin audit failed"
else
  echo "âš ï¸  Lighthouse not available, trying to install locally..."
  if cd frontend && bun add -D lighthouse; then
    echo "âœ… Lighthouse installed locally"
    LIGHTHOUSE_CMD="frontend/node_modules/.bin/lighthouse"
    mkdir -p ../tests/infrastructure/performance
    $LIGHTHOUSE_CMD http://0.0.0.0:49985 --output json --output-path ../tests/infrastructure/performance/lighthouse-results.json || echo "âš ï¸  Lighthouse audit failed"
  else
    echo "âš ï¸  Failed to install Lighthouse"
  fi
fi

âš ï¸  OWASP ZAP not installed, skipping DAST scan
ğŸ­ Ejecutando tests E2E con TestCafe...
task: [test:e2e:testcafe] # Try different ways to find testcafe
TESTCAFE_CMD=""
if command -v testcafe >/dev/null 2>&1; then
  TESTCAFE_CMD="testcafe"
elif command -v npx >/dev/null 2>&1; then
  TESTCAFE_CMD="npx testcafe"
elif [ -f "../../../frontend/node_modules/.bin/testcafe" ]; then
  TESTCAFE_CMD="../../../frontend/node_modules/.bin/testcafe"
fi

if [ -n "$TESTCAFE_CMD" ]; then
  for test_file in *.js; do
    if [ -f "$test_file" ]; then
      echo "  ğŸ§ª Ejecutando E2E test: $test_file"
      $TESTCAFE_CMD chrome:headless "$test_file" || echo "âš ï¸  E2E test $test_file failed"
    fi
  done
else
  echo "âš ï¸  TestCafe not available, skipping E2E tests"
  echo "ğŸ’¡ Hint: Run 'cd frontend && bun add -D testcafe' to install TestCafe"
fi

ğŸ¦€ Instalando dependencias de Rust...
task: [setup:deps:rust] rustup component add rustfmt clippy
  ğŸ“± Testing iPhone...
  ğŸ§ª Ejecutando test-dni-api.js...
âš ï¸  Nuclei not installed, skipping vulnerability scan
  ğŸ§ª Testing Chrome...
  ğŸ§ª Ejecutando test de DB: db-integration.test.sql
$ vitest run
/nix/store/345523198bcsdzay55pfiimkiajq6lq8-bash-interactive-5.2p37/bin/bash: line 1: vitest: command not found
error: script "test" exited with code 127
error: "/nix/store/0qrgvvnnvw55xnk7bn8pbz2rqy6m8x15-coreutils-9.7/bin/test" exited with code 1
note: a package.json script "test" was not found
exit status 127