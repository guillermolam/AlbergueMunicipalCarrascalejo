# Taskfile para desarrollo local
# Inicia, detiene y monitorea servicios

version: "3"

vars:
  SCRIPTS_DIR: scripts/development
  ENV_FILE: .env.ports

# Architecture: taskfile -> taskfiles -> cargo -> backend/cargo -> gateway/cargo -> frontend/package.json
tasks:
  start:
    desc: Inicia todos los servicios en modo desarrollo
    deps: [ports:validate]
    cmds:
      - echo "Iniciando servicios de desarrollo..."
      - task: start:backend
      - task: start:frontend
      - task: start:gateway

  start:backend:
    desc: Inicia todos los servicios del backend
    cmds:
      - echo "Iniciando servicios del backend..."
      - bash {{.SCRIPTS_DIR}}/start-services.sh backend

  start:frontend:
    desc: Inicia el frontend en modo desarrollo
    dir: frontend
    cmds:
      - echo "Iniciando frontend..."
      - bun run dev

  start:gateway:
    desc: Inicia el gateway
    dir: gateway
    cmds:
      - echo "Iniciando gateway..."
      - spin up

  start:prod:
    desc: Inicia todos los servicios en modo produccion
    cmds:
      - echo "Iniciando servicios en modo produccion..."
      - task: start:prod:backend
      - task: start:prod:frontend
      - task: start:prod:gateway

  prod:backend:
    desc: Inicia backend en modo produccion
    cmds:
      - echo "Iniciando backend en produccion..."
      - bash {{.SCRIPTS_DIR}}/start-services.sh prod

  prod:frontend:
    desc: Inicia frontend en modo produccion
    dir: frontend
    cmds:
      - echo "Iniciando frontend en produccion..."
      - bun run build && bun run preview

  prod:gateway:
    desc: Inicia gateway en modo produccion
    dir: gateway
    cmds:
      - echo "Iniciando gateway en produccion..."
      - spin up --release

  stop:
    desc: Detiene todos los servicios
    cmds:
      - echo "Deteniendo servicios..."
      - bash {{.SCRIPTS_DIR}}/stop-services.sh

  restart:
    desc: Reinicia todos los servicios
    cmds:
      - task: stop
      - task: start

  restart:prod:
    desc: Reinicia todos los servicios en produccion
    cmds:
      - task: stop
      - task: start:prod

  status:
    desc: Muestra el estado de los servicios
    cmds:
      - echo "Estado de servicios:"
      - bash {{.SCRIPTS_DIR}}/status-services.sh || echo "Script de estado no disponible"

  clean:
    desc: Limpia servicios de desarrollo
    cmds:
      - echo "Limpiando servicios de desarrollo..."
      - task: stop

  health:
    desc: Verifica salud de todos los servicios
    cmds:
      - echo "Verificando salud de servicios..."
      - bash {{.SCRIPTS_DIR}}/health-check.sh || echo "Health check no configurado"

  logs:
    desc: Muestra logs de todos los servicios
    cmds:
      - echo "Mostrando logs..."
      - bash {{.SCRIPTS_DIR}}/show-logs.sh || echo "Logs no configurados"

  reload:
    desc: Recarga configuracion sin reiniciar
    cmds:
      - echo "Recargando configuracion..."
      - bash {{.SCRIPTS_DIR}}/reload-services.sh || echo "Reload no configurado"
